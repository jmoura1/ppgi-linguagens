\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \begin{itemize}
      \item Subtipos fornecem ao programador uma maior flexibilidade na escrita do código, \textbf{o que pode ocasionar alguma sobrecarga em tempo de execução}
      \begin{itemize}
         \item [$\times$] seja por consequência da representação de dados em uma máquina real
         \begin{align*}
            \texttt{Int} \subtype \texttt{Float} & &
         \end{align*}
         \item [$\times$] ou pela natureza das linguagens de programação funcionais
         \begin{align*}
            \texttt{\{l}_i \texttt{=} \texttt{v}_i ~^ {i \in 1..n}\texttt{\}}.\texttt{l}_j \rightarrow \texttt{v}_i
               & & \mbox{\rulename{(E-ProjRcd)}}
         \end{align*}
      \end{itemize}
   \end{itemize}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item Ideia principal: \textbf{substituir} expressões que envolvem subtipos por expressões de mais ``baixo nível''
      \begin{itemize}
         \item [$\checkmark$] processo que ocorre em tempo de execução
         \item [$\checkmark$] geralmente as expressões são compiladas para uma linguagem próxima a de máquina
      \end{itemize}
      \item Tudo em razão da performance:
      \begin{itemize}
         \item [$\checkmark$]  reduzir a necessidade de \textbf{buscas} durante a execução de código
      \end{itemize}
      \item No livro-texto da disciplina
      \begin{itemize}
         \item [$\checkmark$]  Linguagem utilizada pelo programador: $\lambda_{\hspace{-4pt}\textttf{\subtype}}$ %Cálculo lambda simplesmente tipado com subtipos e registros
         \item [$\checkmark$]  Linguagem de baixo nível: $\lambda_{\rightarrow}$ %Cálculo lambda puro com registros e tipo \texttt{Unit}
      \end{itemize}
   \end{itemize}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item É vista como uma função que \textbf{toma um tipo e devolve outro}
      \item É expressa por \obrack---\cbrack
      \begin{align*}
         & \mbox{\textttf{\obrack Top\cbrack}} & &= \mbox{\textttf{Unit}}\\
         & \mbox{\textttf{\obrack T$_1\rightarrow$ T$_2$\cbrack}} & &= \mbox{\obrack \textttf{T$_1$}\cbrack $\rightarrow$ \obrack \textttf{T$_2$}\cbrack}\\
         & \mbox{\textttf{\obrack \{l$_i$:T$_i~^{i \in 1..n}$\}\cbrack}} &
            & = \mbox{\{\textttf{l$_i$:\obrack T$_i$\cbrack $^{i \in 1..n}$}\}}
      \end{align*}
   \end{itemize}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item Em tempo de execução as coerções são inseridas nos locais onde ocorrem \textit{subsumptions}
      \item \cite{pierce} sugere a formalização de coerções como \textbf{funções de derivação de tipos}
   \end{itemize}
   \begin{align*}
      \mathcal{C} \ \mathrm{::} \ & \mbox{\textttf{S \subtype T}}\\
      \mathcal{D} \ \mathrm{::} \ & \mbox{\textttf{$\Gamma \vdash $ t:T}}
   \end{align*}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item Mas não basta saber que \textttf{S\subtype T}
      \begin{itemize}
         \item [$\checkmark$] não basta inventar uma regra e adotá-la
         \item [$\checkmark$] as regras de subtipagem justificam o emprego das coerções
         \item [$\checkmark$] interpretadas como \textbf{árvores de derivação de subtipos}
      \end{itemize}
   \end{itemize}
   \begin{align*}
      & \textttf{\huge\obrack} \mbox{
         \infer [\rulename{\scriptsize(S-Refl)}] {\textttf{T\subtype T}} {}
      } \textttf{\huge\cbrack} & & = & \lambda \textttf{x:\obrack T\cbrack .x}
      \\
      & \textttf{\Huge\obrack} \mbox{\scriptsize
         \infer [\rulename{\scriptsize(S-Trans)}] {\textttf{S\subtype T}} {
            \textttf{$\mathcal{C}_1\ \mathrm{::}\ $S\subtype U} & \quad \textttf{$\mathcal{C}_2\ \mathrm{::}\ $U\subtype T} &
         }
      } \textttf{\Huge\cbrack} & & = & \lambda \textttf{x:\obrack S\cbrack .\obrack $\mathcal{C}_2$\cbrack(\obrack $\mathcal{C}_1$\cbrack\ x)}
   \end{align*}
 \end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item \textbf{Lema:} Se $\mathcal{C}\ \mathrm{::}\ $ \textttf{S\subtype T}, então
         $\vdash$ \textttf{\obrack}$\mathcal{C}$\textttf{\cbrack\ :}
         \textttf{\obrack S\cbrack\ $\rightarrow$ \obrack T\cbrack}
      \begin{flushright}
         $\square$
      \end{flushright}
   \end{itemize}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item Coerções interagem com o contexto de tipos
      \begin{itemize}
         \item [$\checkmark$] interpretadas como \textbf{derivações de tipos}
      \end{itemize}
   \end{itemize}
   \begin{align*}
      & \textttf{\Huge\obrack} \mbox{\scriptsize
         \infer [\rulename{\scriptsize(T-Sub)}] {\textttf{$\Gamma \vdash$ t : T}} {
            \textttf{$\mathcal{D}\ \mathrm{::}\ \Gamma \vdash\ $t : S} & \quad \textttf{$\mathcal{C}\ \mathrm{::}\ $S\subtype T} &
         }
      } \textttf{\Huge\cbrack} & & = & \textttf{\obrack $\mathcal{C}$\cbrack \obrack $\mathcal{D}$\cbrack}
   \end{align*}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item \textbf{Teorema:} Se $\mathcal{D}\ \mathrm{::}\ \vdash $ \textttf{t : T}, então
         \textttf{\obrack $\Gamma$\cbrack} é a extensão ponto a ponto entre os contextos de tipos
         \textttf{\obrack $\varnothing$\cbrack\ = $\varnothing$} e \\ \texttt{\obrack $\Gamma$, x:T\cbrack\ = \obrack $\Gamma$\cbrack, x:\obrack T\cbrack}
      \begin{flushright}
         $\square$
      \end{flushright}
   \end{itemize}
\end{frame}

\begin{frame}
   \frametitle{15.6 Semântica de coerção para sistema de subtipos}
   \textbf{Semânticas de coerção}\\
   \begin{itemize}
      \item Cuidado com a \textbf{coerência}
      \begin{itemize}
         \item [$\checkmark$] Derivação de tipos não deve incluir ambiguidades na linguagem
      \end{itemize}
      \item \textbf{Definição: } Uma tradução \obrack ---\cbrack\ para a derivação de tipos de uma linguagem para termos de outra é coerente se, para cada par de derivações $\mathcal{D}_1$ e $\mathcal{D}_2$ com a mesma conclusão $\Gamma \vdash$ \textttf{t:T}, as traduções \texttt{\obrack} $\mathcal{D}_1$\texttt{\cbrack} e \texttt{\obrack} $\mathcal{D}_2$\texttt{\cbrack} apresentam o mesmo comportamento na liguagem de destino.
   \end{itemize}
\end{frame}









\begin{frame}
   \frametitle{15.7 Os tipos Interseção e União}
   \begin{align*}
   & \mbox{
      \textttf{T$_1$ $\wedge$ T$_2$ \subtype\ T$_1$}
   } & & \mbox{\rulename{(S-Inter1)}}\\
   & \mbox{
      \textttf{T$_1$ $\wedge$ T$_2$ \subtype\ T$_2$}
   } & & \mbox{\rulename{(S-Inter2)}}\\
   & \mbox{
      \infer {\textttf{S \subtype\ T$_1$ $\wedge$ T$_2$}} {
         \textttf{S \subtype\ T$_1$} & \textttf{S \subtype\ T$_2$}
      }
   } & & \mbox{\rulename{(S-Inter3)}}\\
   & \mbox{
      \textttf{S $\rightarrow$ T$_1$ $\wedge$ S $\rightarrow$ T$_2$ \subtype\ S $\rightarrow$ (T$_1$ $\wedge$ T$_2$)}
   } & & \mbox{\rulename{(S-Inter4)}}
   \end{align*}
   \begin{itemize}
      \item [] De forma semelhante para o tipo \textbf{União}
   \end{itemize}
\end{frame}



% \begin{block}{}
%    \centering
%    \texttt{\frenchspacing($\lambda$x:\{y: Nat\}.x.y) \{x: 4, y: 8\}}
% \end{block}
% \infer [\rulename{S-Trans}] {\textttf{\{x: Nat, y: Nat\} \subtype  \{y: Nat\}}} {
%    \infer [\rulename{S-RcdPerm}] {
%       \begin{array}{@{}c}
%          \textttf{\{y: Nat, x: Nat\}} \\ \subtype \textttf{\{x: Nat, y: Nat\}}
%       \end{array}
%    } {} &
%    \infer [\textsc{S-RcdWidth}] {
%       \begin{array}{@{}c}
%          \textttf{\{y: Nat, x: Nat\}} \\ \subtype \textttf{\{y: Nat\}}
%       \end{array}
%    } {}
% }
